@page "/"

@inject IJSRuntime JS

<div class="velo-card">
    <h2 class="text-center"><span class="LogoFont">VELO  </span> <span class="LogoDescription">Image Size Optimizer</span></h2>

    <div class="upload-zone mb-3">
        <input type="file" @onchange="OnFilesSelected" @ref="fileInputRef" id="fileInput" multiple class="form-control" />
    </div>

    @if (pendingFiles.Any() && !isProcessing)
    {
        <div class="pending-list mb-3">
            <h5 class="text-muted small uppercase">File in coda (@pendingFiles.Count)</h5>
            @foreach (var file in pendingFiles)
            {
                <div class="d-flex justify-content-between align-items-center p-2 mb-1 bg-dark text-white border border-secondary rounded">
                    <span class="text-truncate" style="max-width: 60%;">@file.Name</span>
                    <div class="d-flex align-items-center">
                        <small class="me-3 text-muted">@(file.Size / 1024) KB</small>
                        <button class="btn btn-sm btn-outline-danger" style="width:28px" @onclick="() => RemoveFile(file)">✕</button>
                    </div>
                </div>
            }
            <button class="btn btn-primary w-100 mt-3" @onclick="StartConversion">Ottimizza Tutto</button>
        </div>
    }

    @if (isProcessing)
    {
        <div class="progress mb-3" style="height: 10px;">
            <div class="progress-bar progress-bar-animated bg-info" style="width: @(progressPercentage)%"></div>
        </div>
    }

    @if (results.Any())
    {
        <div class="results-list mb-3">
            <h5 class="text-muted small uppercase">File ottimizzati</h5>
            @foreach (var res in results)
            {
                <div class="d-flex justify-content-between align-items-center p-2 mb-1 bg-dark text-white border border-success rounded">
                    <span class="text-truncate" style="max-width: 60%;">@res.FileName</span>
                    <div class="d-flex align-items-center">
                        <small class="me-3">
                            <span class="text-muted">@res.CompressedSize KB</span> 
                            <span class="text-success ms-1">(-@res.Savings%)</span>
                        </small>
                        <a href="@res.Url" download="Velo_@res.FileName" class="btn btn-sm btn-success">Download</a>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool isProcessing = false;
    private ElementReference fileInputRef;
    private List<FileEntry> pendingFiles = new();
    private List<VeloProcessedResult> results = new();
    private double progressPercentage = 0;

    private async Task OnFilesSelected(ChangeEventArgs e)
    {
        var newFiles = await JS.InvokeAsync<List<FileEntry>>("getSelectedFilesInfo", fileInputRef);
        pendingFiles.AddRange(newFiles); // Aggiunge alla lista esistente
        results.Clear();
        StateHasChanged();
    }

private async Task RemoveFile(FileEntry file)
    {
        pendingFiles.Remove(file);
        await JS.InvokeVoidAsync("removeFromCache", file.InternalId);
    }

private async Task StartConversion()
    {
        if (!pendingFiles.Any()) return;
        isProcessing = true;
        StateHasChanged();

        foreach (var file in pendingFiles)
        {
            // Passiamo l'ID unico, non più l'indice o il riferimento all'input
            var nativeRes = await JS.InvokeAsync<NativeResult>("compressNativeVelo", file.InternalId, 75);

            results.Add(new VeloProcessedResult {
                FileName = nativeRes.FileName,
                Url = nativeRes.Url,
                CompressedSize = nativeRes.Data.Length / 1024,
                Savings = Math.Round(100 - ((double)nativeRes.Data.Length / nativeRes.OrigSize * 100), 1)
            });
        }

        await JS.InvokeVoidAsync("clearVeloCache");
        pendingFiles.Clear();
        isProcessing = false;
        StateHasChanged();
    }

    public class FileEntry {
        public string Name { get; set; } = "";
        public long Size { get; set; }
        public double InternalId { get; set; } // Identificatore unico per la cache JS
    }
    public class NativeResult {
        public byte[] Data { get; set; } = Array.Empty<byte>();
        public string Url { get; set; } = "";
        public long OrigSize { get; set; }
        public string FileName { get; set; } = "";
    }

    public class VeloProcessedResult {
        public string FileName { get; set; } = "";
        public string Url { get; set; } = "";
        public long CompressedSize { get; set; }
        public double Savings { get; set; }
    }
    
}